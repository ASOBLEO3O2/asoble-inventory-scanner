<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>æ£šå¸ã‚¹ã‚­ãƒ£ãƒŠ</title>
  <style>
    body{
      font-family:system-ui,-apple-system,"Noto Sans JP",sans-serif;
      background:#0b0f17;color:#e8eefc;margin:0
    }
    .wrap{max-width:1100px;margin:18px auto;padding:0 14px}
    .top{display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .badge{padding:6px 10px;border-radius:999px;background:#162242;border:1px solid #2b3a60;font-size:13px}
    .btn{padding:10px 12px;border-radius:12px;border:1px solid #2b3a60;background:#162242;color:#e8eefc;cursor:pointer}
    .btn:active{transform:scale(0.99)}
    .card{background:#11182a;border:1px solid #22304f;border-radius:16px;padding:14px;margin-top:12px}
    input{
      width:100%;padding:16px 12px;border-radius:14px;
      border:1px solid #2b3a60;background:#0b1020;color:#e8eefc;font-size:18px
    }
    .grid{display:grid;grid-template-columns:1fr;gap:12px;margin-top:12px}
    @media(min-width:900px){.grid{grid-template-columns:1fr 1fr}}
    .list{
      height:46vh;min-height:280px;overflow:auto;white-space:pre-wrap;
      font-family:ui-monospace,Menlo,Consolas,monospace;font-size:13px;line-height:1.45
    }
    .ok{color:#7CFF8A}.ng{color:#FF7C7C}.muted{color:#9bb0d6}
    .storeGrid{display:grid;grid-template-columns:1fr;gap:10px;margin-top:10px}
    @media(min-width:680px){.storeGrid{grid-template-columns:1fr 1fr}}
    a.storeCard{
      display:block;text-decoration:none;color:inherit;
      background:#11182a;border:1px solid #22304f;border-radius:16px;padding:14px
    }
    a.storeCard:active{transform:scale(0.99)}
    .storeName{font-weight:800;font-size:18px}
    .pill{
      display:inline-block;margin-top:10px;padding:4px 10px;
      border-radius:999px;background:#162242;border:1px solid #2b3a60;font-size:12px
    }
    /* camera */
    .cameraWrap{
      margin-top:10px;
      display:none;
      border:1px solid #22304f;
      border-radius:16px;
      overflow:hidden;
      background:#0b1020;
    }
    .cameraHead{
      display:flex;
      gap:8px;
      align-items:center;
      justify-content:space-between;
      padding:10px 10px;
      border-bottom:1px solid #22304f;
      background:#0f1730;
    }
    .cameraBody{
      padding:10px;
    }
    #qrReader{
      width:100%;
      max-width:520px;
      margin:0 auto;
    }
  </style>

  <!-- âœ… ã‚«ãƒ¡ãƒ©èª­ã¿å–ã‚Šãƒ©ã‚¤ãƒ–ãƒ©ãƒªï¼ˆGitHub Pagesã§OK / HTTPSå¿…é ˆï¼‰ -->
  <script src="https://unpkg.com/html5-qrcode"></script>
</head>

<body>
<div class="wrap">

  <!-- ===== ä¸Šéƒ¨ ===== -->
  <div class="top">
    <div class="row">
      <b id="title">æ£šå¸ã‚¹ã‚­ãƒ£ãƒŠ</b>
      <span class="badge" id="storeBadge">store: -</span>
      <span class="badge" id="countBadge">rows: -</span>
      <span class="badge" id="progressBadge">progress: -</span>
      <span class="badge" id="updatedBadge">updated: -</span>
    </div>
    <div class="row">
      <button class="btn" id="btnHome">åº—èˆ—ä¸€è¦§</button>
      <button class="btn" id="btnClear">ä»Šå›ã‚’ã‚¯ãƒªã‚¢</button>
    </div>
  </div>

  <!-- ===== åº—èˆ—ä¸€è¦§ ===== -->
  <div id="home" class="card" style="display:none">
    <div class="muted">åº—èˆ—ã‚’é¸ã¶ã¨ã‚¹ã‚­ãƒ£ãƒ³ç”»é¢ã«ç§»å‹•ã—ã¾ã™ï¼ˆåŒã˜ãƒšãƒ¼ã‚¸å†…ã§åˆ‡æ›¿ï¼‰ã€‚</div>
    <div class="storeGrid" id="storeGrid"></div>
  </div>

  <!-- ===== ã‚¹ã‚­ãƒ£ãƒ³ç”»é¢ ===== -->
  <div id="scanner" style="display:none">

    <div class="card">
      <div class="muted">â€» ã‚«ãƒ¡ãƒ© or ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚¹ã‚­ãƒ£ãƒŠï¼ˆã‚­ãƒ¼ãƒœãƒ¼ãƒ‰å…¥åŠ›ï¼‰â†’ Enterã§ç¢ºå®šã€‚å…¥åŠ›æ¬„ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã—ãŸã¾ã¾é‹ç”¨ã€‚</div>

      <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:10px">
        <button class="btn" id="btnCamera">ğŸ“· ã‚«ãƒ¡ãƒ©ã§ã‚¹ã‚­ãƒ£ãƒ³</button>
        <button class="btn" id="btnStopCamera">â–  ã‚«ãƒ¡ãƒ©åœæ­¢</button>
      </div>

      <div class="cameraWrap" id="cameraWrap">
        <div class="cameraHead">
          <div class="muted">ã‚«ãƒ¡ãƒ©ã‚’ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã«å‘ã‘ã¦ãã ã•ã„ï¼ˆèª­å–ã£ãŸã‚‰è‡ªå‹•ã§æ­¢ã¾ã‚Šã¾ã™ï¼‰</div>
        </div>
        <div class="cameraBody">
          <div id="qrReader"></div>
        </div>
      </div>

      <div style="height:10px"></div>
      <input id="scanInput" inputmode="none" placeholder="ã“ã“ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ â†’ ã‚¹ã‚­ãƒ£ãƒ³..." autocomplete="off" />
      <div id="msg" class="muted" style="margin-top:10px"></div>
    </div>

    <div class="grid">
      <div class="card">
        <div class="row" style="justify-content:space-between">
          <b>ç¾åœ¨ã®ä¸€è‡´</b><span class="badge" id="hitBadge">-</span>
        </div>
        <div id="current" class="list" style="margin-top:10px"></div>
      </div>

      <div class="card">
        <div class="row" style="justify-content:space-between">
          <b>ã‚¹ã‚­ãƒ£ãƒ³å±¥æ­´ï¼ˆä»Šå›ï¼‰</b><span class="badge" id="historyBadge">0</span>
        </div>
        <div id="history" class="list" style="margin-top:10px"></div>
      </div>
    </div>

  </div>
</div>

<script>
/* ================= è¨­å®š ================= */

// â˜… ã‚ãªãŸã®å…¬é–‹CSVï¼ˆãã®ã¾ã¾ï¼‰
const DATA_CSV_URL =
 "https://docs.google.com/spreadsheets/d/e/2PACX-1vRWOsLuIiIAdMPSlO896mqWtV6wwPdnRtofYq11XqKWwKeg1rauOgt0_mMOxbvP3smksrXMCV5ZROaG/pub?gid=2104427305&single=true&output=csv";

/* ================= çŠ¶æ…‹ ================= */

const el = id => document.getElementById(id);
const qs = new URLSearchParams(location.search);
let STORE = (qs.get("store") || "").trim();

const st = { all:[], rows:[], byCode:new Map(), scanned:[] };

/* ================= å…±é€š ================= */

const normalizeCode = v =>
  String(v ?? "")
    .trim()
    .replace(/\r?\n/g,"")
    .replace(/[ï¼-ï¼™]/g,c=>String.fromCharCode(c.charCodeAt(0)-0xFEE0));

function esc(s){
  return String(s ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#39;");
}

function fmt(ts){ return new Date(ts).toLocaleString("ja-JP"); }

/**
 * æœ€ä½é™ã®CSVãƒ‘ãƒ¼ã‚µï¼ˆãƒ€ãƒ–ãƒ«ã‚¯ã‚©ãƒ¼ãƒˆ/ã‚«ãƒ³ãƒ/æ”¹è¡Œå¯¾å¿œï¼‰
 */
function parseCSV(text){
  const rows = [];
  let row = [];
  let cur = "";
  let inQ = false;

  const s = text.replace(/\r/g,"");
  for(let i=0;i<s.length;i++){
    const ch = s[i];

    if(inQ){
      if(ch === '"'){
        if(s[i+1] === '"'){ cur += '"'; i++; }
        else inQ = false;
      }else{
        cur += ch;
      }
      continue;
    }

    if(ch === '"') inQ = true;
    else if(ch === ','){ row.push(cur); cur=""; }
    else if(ch === '\n'){
      row.push(cur); cur="";
      if(row.some(v=>v!=="")) rows.push(row);
      row=[];
    }else cur += ch;
  }
  row.push(cur);
  if(row.some(v=>v!=="")) rows.push(row);

  if(!rows.length) return [];

  const header = rows.shift().map(x => String(x || "").trim());
  const idx = {};
  header.forEach((h,i)=>idx[h]=i);

  const pick = (cols, key) => (idx[key] == null) ? "" : (cols[idx[key]] ?? "");

  return rows.map(cols => ({
    store_key: pick(cols,"store_key"),
    store_name: pick(cols,"store_name"),
    code: pick(cols,"code"),
    machine_name: pick(cols,"machine_name"),
    actual_stock: pick(cols,"actual_stock"),
    updated_at: pick(cols,"updated_at"),
  }));
}

/* ================= ç”»é¢åˆ‡æ›¿ ================= */

function setMode(mode){
  el("home").style.display = (mode==="home") ? "" : "none";
  el("scanner").style.display = (mode==="scanner") ? "" : "none";
}

/* ================= ãƒãƒƒã‚¸/è¡¨ç¤º ================= */

function updateBadges(){
  el("storeBadge").textContent = "store: " + (STORE || "HOME");
  el("countBadge").textContent = "rows: " + (STORE ? st.rows.length : "-");
  const u = st.rows[0]?.updated_at || st.all[0]?.updated_at || "-";
  el("updatedBadge").textContent = "updated: " + (u ? String(u).slice(0,10) : "-");
  el("historyBadge").textContent = String(st.scanned.length);

  if(!STORE){
    el("progressBadge").textContent = "progress: -";
    return;
  }
  const total = st.rows.length;
  const okSet = new Set(st.scanned.filter(x=>x.ok).map(x=>x.code));
  const done = okSet.size;
  const pct = total ? Math.round(done * 1000 / total) / 10 : 0; // å°æ•°1æ¡
  const remain = Math.max(0, total - done);
  el("progressBadge").textContent = `progress: ${done}/${total} (${pct}%)  remain:${remain}`;
}

function renderHome(){
  setMode("home");
  el("title").textContent = "æ£šå¸ã‚¹ã‚­ãƒ£ãƒŠï¼ˆåº—èˆ—é¸æŠï¼‰";
  st.scanned = [];
  updateBadges();

  // storeä¸€è¦§ã‚’DATAã‹ã‚‰è‡ªå‹•æŠ½å‡º
  const map = new Map(); // key -> name
  for(const r of st.all){
    if(!r.store_key) continue;
    if(!map.has(r.store_key)) map.set(r.store_key, r.store_name || r.store_key);
  }

  const items = [...map.entries()].sort((a,b)=>String(a[1]).localeCompare(String(b[1]),"ja"));
  el("storeGrid").innerHTML = items.map(([key,name])=>{
    const href = `?store=${encodeURIComponent(key)}`;
    return `<a class="storeCard" href="${href}">
      <div class="storeName">${esc(name)}</div>
      <div class="muted">store_key: ${esc(key)}</div>
      <div class="pill">ã‚¹ã‚­ãƒ£ãƒ³ã¸</div>
    </a>`;
  }).join("");
}

function renderScanPanels(){
  updateBadges();

  const last = st.scanned[0];
  if(!last){
    el("hitBadge").textContent = "-";
    el("current").textContent = "";
  }else if(last.ok){
    el("hitBadge").textContent = "HIT";
    const r = last.row;
    el("current").innerHTML =
      `<div class="ok">âœ… ${esc(last.code)}</div>` +
      `<div>åº—èˆ—: ${esc(r.store_name)} (${esc(r.store_key)})</div>` +
      `<div>ãƒã‚·ãƒ³: ${esc(r.machine_name)}</div>` +
      `<div>å®Ÿåœ¨åº«: ${esc(r.actual_stock)}</div>`;
  }else{
    el("hitBadge").textContent = "NO HIT";
    el("current").innerHTML = `<div class="ng">âŒ ${esc(last.code)}</div>`;
  }

  el("history").innerHTML = st.scanned.map(x=>{
    const head = x.ok ? `<span class="ok">âœ…</span>` : `<span class="ng">âŒ</span>`;
    const tail = x.ok ? ` ${esc(x.row.machine_name)}` : "";
    return `${head} ${esc(x.code)}  <span class="muted">${fmt(x.ts)}</span>${tail}`;
  }).join("\n");
}

function renderScanner(){
  setMode("scanner");
  el("title").textContent = "æ£šå¸ã‚¹ã‚­ãƒ£ãƒŠ";
  el("msg").textContent = "èª­è¾¼å®Œäº†ã€‚å…¥åŠ›æ¬„ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã—ã¦ã‚¹ã‚­ãƒ£ãƒ³ã—ã¦ãã ã•ã„ã€‚";
  renderScanPanels();
  el("scanInput").focus();
}

/* ================= åº—èˆ—åˆ‡æ›¿ ================= */

function setStore(key){
  STORE = (key || "").trim();

  if(!STORE){
    // HOMEã¸
    stopCamera_();
    history.replaceState(null,"","./");
    renderHome();
    return;
  }

  history.replaceState(null,"",`?store=${encodeURIComponent(STORE)}`);

  // çµã‚Šè¾¼ã¿
  st.rows = st.all.filter(r => String(r.store_key).trim() === STORE);

  st.byCode.clear();
  for(const r of st.rows){
    const k = normalizeCode(r.code);
    if(k) st.byCode.set(k, r);
  }

  st.scanned = [];
  stopCamera_();
  renderScanner();
}

/* ================= ã‚¹ã‚­ãƒ£ãƒ³å‡¦ç† ================= */

function addScan(value){
  const c = normalizeCode(value);
  if(!c) return;

  const row = st.byCode.get(c);
  const ok = !!row;

  st.scanned.unshift({ ts: Date.now(), code: c, ok, row });
  el("msg").textContent = ok ? "ä¸€è‡´ã—ã¾ã—ãŸ" : "ä¸€è‡´ãªã—ï¼ˆãƒªã‚¹ãƒˆã«ã‚ã‚Šã¾ã›ã‚“ï¼‰";
  renderScanPanels();
  el("scanInput").focus();
}

/* ================= ã‚«ãƒ¡ãƒ©ã‚¹ã‚­ãƒ£ãƒ³ ================= */

let qr_ = null;
let camRunning_ = false;

async function startCamera_(){
  if(!STORE){
    alert("å…ˆã«åº—èˆ—ã‚’é¸æŠã—ã¦ãã ã•ã„");
    return;
  }

  const wrap = el("cameraWrap");
  wrap.style.display = "";

  // æ—¢å­˜ãŒå‹•ã„ã¦ãŸã‚‰ä½•ã‚‚ã—ãªã„
  if(camRunning_) return;

  if(!qr_){
    qr_ = new Html5Qrcode("qrReader");
  }

  const cams = await Html5Qrcode.getCameras();
  if(!cams || cams.length === 0){
    alert("ã‚«ãƒ¡ãƒ©ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
    wrap.style.display = "none";
    return;
  }

  // èƒŒé¢ã‚«ãƒ¡ãƒ©ã£ã½ã„ã‚‚ã®ã‚’å„ªå…ˆï¼ˆåå‰ã« back / rear / environment ãŒå…¥ã‚‹ã“ã¨ãŒå¤šã„ï¼‰
  const pick = (arr) => {
    const prefer = arr.find(d => /back|rear|environment/i.test(d.label || ""));
    return (prefer || arr[0]).id;
  };
  const cameraId = pick(cams);

  camRunning_ = true;

  // â€» iOSã§ã¯ã€Œãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œï¼ˆãƒœã‚¿ãƒ³ï¼‰ã€ã‹ã‚‰èµ·å‹•ãŒå¿…é ˆ
  await qr_.start(
    { deviceId: { exact: cameraId } },
    {
      fps: 10,
      // 1Dãƒãƒ¼ã‚³ãƒ¼ãƒ‰å‘ã‘ã«æ¨ªé•·ï¼ˆç«¯æœ«ã«ã‚ˆã‚ŠåŠ¹ãæ–¹ãŒé•ã†ã®ã§ã€ã“ã®å€¤ã¯å¾Œã§èª¿æ•´å¯ï¼‰
      qrbox: { width: 360, height: 160 },
      aspectRatio: 1.777,
      disableFlip: true,
      // formatsToSupport: [Html5QrcodeSupportedFormats.CODE_128] // å¿…è¦ãªã‚‰é™å®šå¯èƒ½
    },
    (decodedText) => {
      // èª­ã¿å–ã£ãŸã‚‰åœæ­¢â†’æ£šå¸åˆ¤å®šã¸
      stopCamera_();
      addScan(decodedText);
    },
    (_err) => {
      // èª­å–ä¸­ã®ã‚¨ãƒ©ãƒ¼ã¯ç„¡è¦–ï¼ˆãƒ­ã‚°ãŒã†ã‚‹ã•ã„ã ã‘ï¼‰
    }
  );
}

async function stopCamera_(){
  const wrap = el("cameraWrap");
  wrap.style.display = "none";

  if(!qr_ || !camRunning_) return;

  try{
    await qr_.stop();
  }catch(_e){
    // ãŸã¾ã«stopãŒä¾‹å¤–ã«ãªã‚‹ç«¯æœ«ãŒã‚ã‚‹ãŒç„¡è¦–ã§OK
  }finally{
    camRunning_ = false;
  }
}

/* ================= èµ·å‹• ================= */

async function boot(){
  // ãƒœã‚¿ãƒ³
  el("btnHome").addEventListener("click", () => setStore(""));
  el("btnClear").addEventListener("click", () => {
    st.scanned = [];
    el("msg").textContent = "ä»Šå›åˆ†ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ";
    renderScanPanels();
    el("scanInput").focus();
  });

  el("btnCamera").addEventListener("click", () => startCamera_());
  el("btnStopCamera").addEventListener("click", () => stopCamera_());

  // Enterç¢ºå®šï¼ˆå¤–ä»˜ã‘ã‚¹ã‚­ãƒ£ãƒŠ/ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰å…¥åŠ›ã«ã‚‚å¯¾å¿œï¼‰
  const input = el("scanInput");
  input.addEventListener("keydown", (e) => {
    if(e.key === "Enter"){
      e.preventDefault();
      addScan(input.value);
      input.value = "";
    }
  });

  // iPad/iPhoneã§ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ç¶­æŒï¼ˆå…¥åŠ›æ¬„ã‚’ã‚¿ãƒƒãƒ—ã—ã¦é‹ç”¨ã—ã‚„ã™ãï¼‰
  document.addEventListener("touchstart", () => {
    if(document.activeElement !== input) input.focus();
  }, { passive:true });

  // ãƒ‡ãƒ¼ã‚¿å–å¾—
  el("msg").textContent = "ãƒ‡ãƒ¼ã‚¿èª­è¾¼ä¸­â€¦";
  const res = await fetch(DATA_CSV_URL, { cache:"no-store" });
  if(!res.ok) throw new Error("CSVå–å¾—ã«å¤±æ•—: " + res.status);

  const text = await res.text();
  st.all = parseCSV(text);

  // åˆæœŸè¡¨ç¤º
  const initial = (new URLSearchParams(location.search)).get("store") || "";
  setStore(initial.trim());
}

boot().catch(err=>{
  setMode("scanner");
  el("msg").textContent = "ã‚¨ãƒ©ãƒ¼: " + err.message;
});
</script>
</body>
</html>
