<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>æ£šå¸ã‚¹ã‚­ãƒ£ãƒŠ</title>
<script src="https://unpkg.com/html5-qrcode"></script>

<style>
body{margin:0;font-family:system-ui,-apple-system,BlinkMacSystemFont;background:#0b1220;color:#e5e7eb}
header{padding:14px;font-size:20px;font-weight:700}
.badges{display:flex;flex-wrap:wrap;gap:8px;padding:0 14px 8px}
.badge{background:#1e293b;padding:6px 10px;border-radius:999px;font-size:13px}
button{background:#1e40af;color:#fff;border:none;border-radius:10px;padding:10px 14px;font-size:15px}
button.secondary{background:#334155}
main{padding:14px}
.card{background:#111827;border-radius:14px;padding:14px;margin-bottom:14px}
input{width:100%;padding:14px;font-size:16px;border-radius:12px;border:1px solid #334155;background:#020617;color:#fff}
.small{font-size:13px}
.ok{color:#22c55e}
.ng{color:#ef4444}
.muted{color:#94a3b8;white-space:pre-line}
.storeCard{display:block;background:#020617;border-radius:12px;padding:14px;margin-bottom:10px;text-decoration:none;color:#fff}

/* é€²æ—ãƒãƒ¼ */
.progressWrap{margin-top:10px}
.progressBar{width:100%;height:12px;background:#0b1020;border:1px solid #334155;border-radius:999px;overflow:hidden}
.progressFill{height:100%;width:0%;background:#22c55e}

/* å®Œäº†ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */
#doneOverlay{position:fixed;inset:0;display:none;background:rgba(0,0,0,.55);align-items:center;justify-content:center;z-index:9999}
#doneCard{width:min(560px, calc(100vw - 28px));background:#111827;border:1px solid #334155;border-radius:18px;padding:18px;text-align:center}
#doneTitle{font-size:22px;font-weight:800;margin-bottom:6px}
#doneSub{color:#94a3b8;margin-bottom:14px}

/* ã‚¹ã‚­ãƒ£ãƒ³æ¸ˆã¿ã‚°ãƒ¬ãƒ¼ã‚¢ã‚¦ãƒˆ */
.hitRow{padding:8px 10px;border-radius:12px;border:1px solid #334155;background:#0b1220}
.hitRow.okRow{border-color:#1f6f3a;background:#07140d}
.hitRow.done{opacity:.45;filter:grayscale(1)}
.hitRow .meta{display:flex;flex-wrap:wrap;gap:8px;align-items:baseline}
.hitRow .code{font-weight:800}
.hitRow .machine{color:#cbd5e1}
.hitRow .tag{font-size:12px;padding:2px 8px;border-radius:999px;background:#0f172a;border:1px solid #334155;color:#cbd5e1}

/* ===== ã‚«ãƒ¡ãƒ©å…¨ç”»é¢ãƒ¢ãƒ¼ãƒ€ãƒ« ===== */
#camModal{
  position:fixed; inset:0;
  display:none;
  background:#000;
  z-index:9998;
}
#camTop{
  position:absolute; top:0; left:0; right:0;
  display:flex; gap:10px; align-items:center; justify-content:space-between;
  padding:10px;
  background:linear-gradient(to bottom, rgba(0,0,0,.7), rgba(0,0,0,0));
  z-index:2;
}
#camHint{
  font-size:13px; color:#e5e7eb; opacity:.9;
}
#camClose{
  background:#334155;
}
#qrReader{
  position:absolute; inset:0;
}

/* ã‚³ãƒ¼ãƒŠãƒ¼ã‚¬ã‚¤ãƒ‰ï¼ˆç·šã«å›šã‚ã‚Œãªã„ï¼‰ */
#qrReader::before{
  content:"ã‚·ãƒ¼ãƒ«å…¨ä½“ã‚’æ ã®ä¸­ã¸ï¼ˆèµ¤ç·šã¯ç›®å®‰ï¼‰";
  position:absolute; top:56px; left:0; right:0;
  text-align:center; font-size:13px; color:#ff9aa2;
  z-index:3; pointer-events:none;
}
/* èµ¤ç·šã¯ç›®å®‰ã§è–„ã‚ */
#qrReader::after{
  content:""; position:absolute; top:50%; left:10%;
  width:80%; height:2px; background:#ff3b30; opacity:.35;
  z-index:3; pointer-events:none;
}
/* å››éš…ã‚³ãƒ¼ãƒŠãƒ¼ */
.corner{position:absolute;width:34px;height:34px;border:3px solid rgba(34,197,94,.85);border-right:none;border-bottom:none;border-radius:10px;z-index:3;pointer-events:none}
.corner.tr{right:14px;top:120px;transform:rotate(90deg)}
.corner.br{right:14px;bottom:14px;transform:rotate(180deg)}
.corner.bl{left:14px;bottom:14px;transform:rotate(270deg)}
.corner.tl{left:14px;top:120px}
#camFrame{
  position:absolute;
  left:14px; right:14px;
  top:120px; bottom:14px;
  z-index:2;
  pointer-events:none;
}
</style>
</head>

<body>
<header id="title">æ£šå¸ã‚¹ã‚­ãƒ£ãƒŠï¼ˆåº—èˆ—é¸æŠï¼‰</header>

<div class="badges">
  <div class="badge" id="storeBadge">store: HOME</div>
  <div class="badge" id="countBadge">rows: -</div>
  <div class="badge" id="progressBadge">progress: -</div>
  <div class="badge" id="remainBadge">remain: -</div>
  <div class="badge" id="ngBadge">ng: 0</div>
  <div class="badge" id="updatedBadge">updated: -</div>
</div>

<main>
  <!-- åº—èˆ—é¸æŠ -->
  <div id="home" class="card">
    <div class="muted small">åº—èˆ—ã‚’é¸ã¶ã¨ã‚¹ã‚­ãƒ£ãƒ³ç”»é¢ã«ç§»å‹•ã—ã¾ã™ã€‚</div>
    <div id="storeGrid" style="margin-top:10px"></div>
  </div>

  <!-- ã‚¹ã‚­ãƒ£ãƒŠ -->
  <div id="scanner" style="display:none">
    <div class="card">
      <button id="btnHome" class="secondary">åº—èˆ—ä¸€è¦§</button>
      <button id="btnClear" class="secondary">ä»Šå›ã‚’ã‚¯ãƒªã‚¢</button>
      <button id="btnShowRemain" class="secondary">æœªã‚¹ã‚­ãƒ£ãƒ³ä¸€è¦§</button>
    </div>

    <div class="card">
      <p class="muted">
        â€» ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚¹ã‚­ãƒ£ãƒŠé‹ç”¨æ¨å¥¨ï¼ˆEnterã§ç¢ºå®šï¼‰<br>
        ã‚«ãƒ¡ãƒ©ã¯å¿…è¦ãªã¨ãã ã‘å…¨ç”»é¢ã§èµ·å‹•ã—ã¾ã™
      </p>

      <button id="btnCamera">ğŸ“· ã‚«ãƒ¡ãƒ©ã§ã‚¹ã‚­ãƒ£ãƒ³ï¼ˆå…¨ç”»é¢ï¼‰</button>

      <div class="progressWrap">
        <div class="muted small" id="progressText">progress: -</div>
        <div class="progressBar"><div class="progressFill" id="progressFill"></div></div>
      </div>

      <input id="scanInput" placeholder="ã“ã“ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ â†’ ã‚¹ã‚­ãƒ£ãƒ³â€¦" autocomplete="off" />
      <div id="msg" class="muted"></div>
    </div>

    <div class="card">
      <strong>ç¾åœ¨ã®ä¸€è‡´</strong>
      <div id="current" style="margin-top:10px"></div>
    </div>

    <div class="card">
      <strong>ã‚¹ã‚­ãƒ£ãƒ³å±¥æ­´ï¼ˆä»Šå›ï¼‰</strong>
      <div id="history" style="margin-top:10px"></div>
    </div>

    <div class="card" id="remainCard" style="display:none">
      <strong>æœªã‚¹ã‚­ãƒ£ãƒ³ä¸€è¦§ï¼ˆã“ã®åº—èˆ—ï¼‰</strong>
      <div class="muted small" style="margin-top:6px">æ®‹ã‚Šã‚’ã€Œç®¡ç†No ï¼ ãƒã‚·ãƒ³åã€ã§è¡¨ç¤ºï¼ˆé•·ã„å ´åˆã¯ä¸€éƒ¨çœç•¥ï¼‰ã€‚</div>
      <div id="remainList" style="margin-top:10px;white-space:pre-wrap"></div>
    </div>
  </div>
</main>

<!-- æ£šå¸å®Œäº† -->
<div id="doneOverlay">
  <div id="doneCard">
    <div id="doneTitle">æ£šå¸å®Œäº†ï¼ğŸ‰</div>
    <div id="doneSub">å…¨ä»¶ã‚¹ã‚­ãƒ£ãƒ³æ¸ˆã¿ã§ã™</div>
    <button id="btnDoneClose" class="secondary">é–‰ã˜ã‚‹</button>
  </div>
</div>

<!-- ã‚«ãƒ¡ãƒ©å…¨ç”»é¢ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="camModal">
  <div id="camTop">
    <div id="camHint">ã‚·ãƒ¼ãƒ«ï¼ˆ5Ã—3.5cmï¼‰ã‚’æ ã«å…¥ã‚Œã‚‹ã ã‘ã§OK</div>
    <button id="camClose" class="secondary">â¹ é–‰ã˜ã‚‹</button>
  </div>
  <div id="qrReader"></div>
  <div id="camFrame">
    <div class="corner tl"></div>
    <div class="corner tr"></div>
    <div class="corner br"></div>
    <div class="corner bl"></div>
  </div>
</div>

<script>
/* ========= è¨­å®š ========= */
const DATA_CSV_URL =
 "https://docs.google.com/spreadsheets/d/e/2PACX-1vRWOsLuIiIAdMPSlO896mqWtV6wwPdnRtofYq11XqKWwKeg1rauOgt0_mMOxbvP3smksrXMCV5ZROaG/pub?gid=2104427305&single=true&output=csv";

/* ========= çŠ¶æ…‹ ========= */
const el = (id) => document.getElementById(id);
const qs = new URLSearchParams(location.search);
let STORE = (qs.get("store") || "").trim();

const st = {
  all: [],
  rows: [],
  byCode: new Map(),
  scanned: [],
  okSet: new Set(),
  ngCount: 0
};

/* ========= æ­£è¦åŒ– ========= */
const normalize = (s) => String(s ?? "")
  .trim()
  .replace(/\r?\n/g, "")
  .replace(/[ï¼-ï¼™]/g, c => String.fromCharCode(c.charCodeAt(0) - 0xFEE0))
  .replace(/[ãƒ¼âˆ’â€•â€\- ]/g, "")
  .toUpperCase();

function codeVariants(raw){
  const c = normalize(raw);
  if(!c) return [];
  const out = new Set();
  out.add(c);
  out.add(c.replace(/^0+/, ""));
  const digits = c.replace(/\D/g, "");
  if(digits){
    out.add(digits);
    out.add(digits.replace(/^0+/, ""));
  }
  return [...out].filter(Boolean);
}

/* ========= CSV ========= */
function parseCSV(t){
  const lines = t.replace(/\r/g,"").split("\n").filter(Boolean);
  if(!lines.length) return [];
  const header = lines.shift().split(",").map(x=>x.trim());
  const idx = {};
  header.forEach((h,i)=>idx[h]=i);
  const pick = (cols, key) => (idx[key] == null) ? "" : (cols[idx[key]] ?? "");
  return lines.map(line=>{
    const cols = line.split(",").map(x => x.replace(/^"|"$/g,"").replace(/""/g,'"'));
    return {
      store_key: pick(cols,"store_key"),
      store_name: pick(cols,"store_name"),
      code: pick(cols,"code"),
      machine_name: pick(cols,"machine_name"),
      actual_stock: pick(cols,"actual_stock"),
      updated_at: pick(cols,"updated_at"),
    };
  });
}

/* ========= UI ========= */
function setMode(m){
  el("home").style.display = (m==="home")?"":"none";
  el("scanner").style.display = (m==="scan")?"":"none";
}
function pct(n){
  if(!isFinite(n)) return "0.0";
  return (Math.round(n*10)/10).toFixed(1);
}
function vibrateOk(){ try{ if(navigator.vibrate) navigator.vibrate([60,30,60]); }catch(_e){} }
function vibrateDone(){ try{ if(navigator.vibrate) navigator.vibrate([120,60,120,60,220]); }catch(_e){} }

function showDoneIfComplete(){
  if(!STORE) return;
  const total = st.rows.length;
  const done = st.okSet.size;
  if(total > 0 && done >= total){
    el("doneOverlay").style.display = "flex";
    vibrateDone();
  }
}
function hideDone(){ el("doneOverlay").style.display = "none"; }

function updateBadges(){
  el("storeBadge").textContent="store: "+(STORE||"HOME");
  el("countBadge").textContent="rows: "+(STORE?st.rows.length:"-");

  if(!STORE){
    el("progressBadge").textContent="progress: -";
    el("remainBadge").textContent="remain: -";
    el("ngBadge").textContent="ng: 0";
    el("updatedBadge").textContent="updated: "+String(st.all[0]?.updated_at||"-").slice(0,10);
    el("progressText").textContent="progress: -";
    el("progressFill").style.width="0%";
    return;
  }

  const total = st.rows.length;
  const done = st.okSet.size;
  const remain = Math.max(0, total - done);
  const p = total ? (done * 100 / total) : 0;

  el("progressBadge").textContent = `progress: ${done}/${total} (${pct(p)}%)`;
  el("remainBadge").textContent = `remain: ${remain}`;
  el("ngBadge").textContent = `ng: ${st.ngCount}`;
  el("updatedBadge").textContent = "updated: "+String(st.rows[0]?.updated_at||st.all[0]?.updated_at||"-").slice(0,10);

  el("progressText").textContent = `progress: ${done}/${total} (${pct(p)}%)  remain:${remain}`;
  el("progressFill").style.width = `${Math.min(100, Math.max(0,p))}%`;
}

function escapeHtml(s){
  return String(s ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#39;");
}

function renderHitRow(row){
  const codeKey = normalize(row.code);
  const done = st.okSet.has(codeKey);
  const cls = `hitRow okRow ${done ? "done" : ""}`;
  return `
    <div class="${cls}">
      <div class="meta">
        <span class="code">${escapeHtml(row.code)}</span>
        <span class="tag">${done ? "æ¸ˆ" : "æœª"}</span>
      </div>
      <div class="machine">ãƒã‚·ãƒ³: ${escapeHtml(row.machine_name || "-")}</div>
    </div>
  `;
}

function renderHome(){
  setMode("home");
  el("title").textContent = "æ£šå¸ã‚¹ã‚­ãƒ£ãƒŠï¼ˆåº—èˆ—é¸æŠï¼‰";

  const map=new Map();
  for(const r of st.all){
    if(r.store_key && !map.has(r.store_key)) map.set(r.store_key, r.store_name || r.store_key);
  }
  el("storeGrid").innerHTML=[...map.entries()]
    .sort((a,b)=>String(a[1]).localeCompare(String(b[1]),"ja"))
    .map(([k,n])=>`
      <a class="storeCard" href="?store=${encodeURIComponent(k)}">
        <b>${escapeHtml(n)}</b><div class="muted small">${escapeHtml(k)}</div>
      </a>`).join("");

  updateBadges();
}

function renderScan(){
  setMode("scan");
  el("title").textContent = "æ£šå¸ã‚¹ã‚­ãƒ£ãƒŠ";
  el("msg").textContent="èª­è¾¼å®Œäº†ã€‚å…¥åŠ›æ¬„ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã—ã¦ã‚¹ã‚­ãƒ£ãƒ³ã—ã¦ãã ã•ã„ã€‚";
  el("remainCard").style.display = "none";
  updateBadges();
  el("scanInput").focus();
}

function renderPanels(){
  updateBadges();

  const last=st.scanned[0];
  if(!last){
    el("current").innerHTML = "";
  }else if(last.ok){
    el("current").innerHTML = renderHitRow(last.row);
  }else{
    el("current").innerHTML = `<div class="ng">âŒ ${escapeHtml(last.code)}</div>`;
  }

  el("history").innerHTML = st.scanned.slice(0, 80).map(x=>{
    if(!x.ok){
      return `<div class="ng">âŒ ${escapeHtml(x.code)}</div>`;
    }
    const key = normalize(x.row.code);
    const done = st.okSet.has(key);
    const cls = `hitRow okRow ${done ? "done" : ""}`;
    return `
      <div class="${cls}">
        <div class="meta">
          <span class="code">âœ… ${escapeHtml(x.row.code)}</span>
          <span class="tag">${done ? "æ¸ˆ" : "æœª"}</span>
        </div>
        <div class="machine">${escapeHtml(x.row.machine_name || "-")}</div>
      </div>
    `;
  }).join("");
}

function renderRemainList(){
  if(!STORE) return;
  const remainRows = st.rows.filter(r => !st.okSet.has(normalize(r.code)));
  const shown = remainRows.slice(0, 200);
  el("remainList").textContent =
    shown.map(r => `${r.code} ï¼ ${r.machine_name || "-"}`).join("\n")
    + (remainRows.length > shown.length ? `\n...ï¼ˆæ®‹ã‚Š ${remainRows.length - shown.length} ä»¶çœç•¥ï¼‰` : "");
  el("remainCard").style.display = "";
  el("remainCard").scrollIntoView({ behavior:"smooth", block:"start" });
}

/* ========= ã‚¹ã‚­ãƒ£ãƒ³ ========= */
function addScan(v){
  const variants = codeVariants(v);
  if(!variants.length) return;

  let hitRow = null;
  let hitKey = null;

  for(const c of variants){
    const row = st.byCode.get(c);
    if(row){
      hitRow = row;
      hitKey = normalize(row.code);
      break;
    }
  }

  const ok = !!hitRow;

  if(ok){
    const before = st.okSet.size;
    st.okSet.add(hitKey);
    if(st.okSet.size > before){
      vibrateOk();
    }else{
      try{ if(navigator.vibrate) navigator.vibrate(40); }catch(_e){}
    }
  }else{
    st.ngCount++;
  }

  st.scanned.unshift({ code: variants[0], row: hitRow, ok, ts: Date.now(), hitKey });

  el("msg").textContent = ok ? "ä¸€è‡´ã—ã¾ã—ãŸï¼ˆæ¸ˆã¯ã‚°ãƒ¬ãƒ¼è¡¨ç¤ºï¼‰" : "ä¸€è‡´ãªã—ï¼ˆãƒªã‚¹ãƒˆã«ã‚ã‚Šã¾ã›ã‚“ï¼‰";
  renderPanels();
  showDoneIfComplete();
  el("scanInput").focus();
}

/* ========= ã‚«ãƒ¡ãƒ©ï¼ˆå…¨ç”»é¢ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼‰ ========= */
let qr=null, camRunning=false;

function makeQrbox(){
  // ã‚·ãƒ¼ãƒ«æ¯”ç‡ 1.43 ã«è¿‘ã„ 1.5 ã‚’æ¡ç”¨ï¼ˆå°‘ã—ä½™è£•ï¼‰
  const vw = Math.min(window.innerWidth, 700);
  const w = Math.round(vw * 0.82);
  const h = Math.round(w / 1.5);
  const ww = Math.max(260, Math.min(w, 520));
  const hh = Math.max(180, Math.min(h, 360));
  return { width: ww, height: hh };
}

function openCamModal(){
  el("camModal").style.display="block";
}
function closeCamModal(){
  el("camModal").style.display="none";
}

async function startCamera(){
  if(!STORE){ alert("å…ˆã«åº—èˆ—ã‚’é¸æŠã—ã¦ãã ã•ã„"); return; }
  if(camRunning) return;

  openCamModal();
  if(!qr) qr=new Html5Qrcode("qrReader");

  const config={
    fps: 10,
    qrbox: makeQrbox(),
    disableFlip:true,
    formatsToSupport:[
      Html5QrcodeSupportedFormats.EAN_13,
      Html5QrcodeSupportedFormats.EAN_8,
      Html5QrcodeSupportedFormats.UPC_A,
      Html5QrcodeSupportedFormats.UPC_E,
      Html5QrcodeSupportedFormats.CODE_128,
      Html5QrcodeSupportedFormats.CODE_39,
    ],
  };

  const onOk=(text)=>{ stopCamera(); addScan(text); };
  const onErr=(_)=>{};

  camRunning=true;

  try{
    await qr.start({facingMode:"environment"},config,onOk,onErr);
  }catch(e1){
    try{
      const cams=await Html5Qrcode.getCameras();
      const camId=cams[cams.length-1]?.id;
      await qr.start({deviceId:{exact:camId}},config,onOk,onErr);
    }catch(e2){
      camRunning=false;
      closeCamModal();
      alert("ã‚«ãƒ¡ãƒ©èµ·å‹•ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆæ¨©é™/HTTPS/å†èª­ã¿è¾¼ã¿ã‚’ç¢ºèªï¼‰");
    }
  }
}

async function stopCamera(){
  if(!qr||!camRunning){ closeCamModal(); return; }
  try{ await qr.stop(); }catch(_){}
  camRunning=false;
  closeCamModal();
}

/* ========= èµ·å‹• ========= */
(async()=>{
  // å®Œäº†ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤
  el("btnDoneClose").onclick = hideDone;
  el("doneOverlay").addEventListener("click", (e) => {
    if(e.target === el("doneOverlay")) hideDone();
  });

  // ã‚«ãƒ¡ãƒ©é–‰ã˜ã‚‹
  el("camClose").onclick = ()=>stopCamera();
  el("camModal").addEventListener("click", (e)=>{
    // èƒŒæ™¯ã‚¿ãƒƒãƒ—ã§é–‰ã˜ã‚‹ï¼ˆä¸Šéƒ¨ã‚„readerã‚¿ãƒƒãƒ—ã¯é™¤å¤–ã—ãŸã„ã®ã§Modalç›´ä¸‹ã®ã¿ï¼‰
    if(e.target === el("camModal")) stopCamera();
  });

  // UI
  el("btnHome").onclick=()=>location.href="./";
  el("btnClear").onclick=()=>{
    st.scanned=[];
    st.okSet.clear();
    st.ngCount=0;
    el("remainCard").style.display="none";
    el("msg").textContent="ä»Šå›åˆ†ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ";
    renderPanels();
    hideDone();
    el("scanInput").focus();
  };
  el("btnShowRemain").onclick=()=>renderRemainList();

  el("btnCamera").onclick=()=>startCamera();

  el("scanInput").addEventListener("keydown",e=>{
    if(e.key==="Enter"){
      e.preventDefault();
      addScan(el("scanInput").value);
      el("scanInput").value="";
    }
  });

  // iOSã§ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ãŒå¤–ã‚Œã‚„ã™ã„å¯¾ç­–ï¼ˆè»½ã‚ï¼‰
  document.addEventListener("touchstart", () => {
    const inp = el("scanInput");
    if(document.activeElement !== inp) inp.focus();
  }, { passive: true });

  // DATA
  const csv=await fetch(DATA_CSV_URL,{cache:"no-store"}).then(r=>r.text());
  st.all=parseCSV(csv);

  STORE=((new URLSearchParams(location.search)).get("store")||"").trim();
  if(!STORE){ renderHome(); return; }

  st.rows=st.all.filter(r=>String(r.store_key).trim()===STORE);

  st.byCode.clear();
  for(const r of st.rows){
    const base = normalize(r.code);
    if(base) st.byCode.set(base, r);
    const v = codeVariants(r.code);
    for(const k of v){
      if(k) st.byCode.set(k, r);
    }
  }

  renderScan();
  renderPanels();
})();
</script>

</body>
</html>
