<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>棚卸スキャナ</title>

  <link rel="stylesheet" href="./style.css" />

  <!-- ZXing（バーコード） -->
  <script src="https://cdn.jsdelivr.net/npm/@zxing/browser@0.1.5/umd/index.min.js"></script>
  <!-- Tesseract（OCR：番号読み） -->
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5.0.5/dist/tesseract.min.js"></script>
</head>

<body>
  <header id="title">棚卸スキャナ</header>

  <!-- 既存のbadgesは流用（表示内容はJS側で更新） -->
  <div class="badges">
    <div class="badge" id="storeBadge">store: HOME</div>
    <div class="badge" id="countBadge">rows: -</div>
    <div class="badge" id="progressBadge">progress: -</div>
    <div class="badge" id="remainBadge">remain: -</div>
    <div class="badge" id="ngBadge">ng: 0</div>
    <div class="badge" id="updatedBadge">updated: -</div>
  </div>

  <main>
    <!-- ① 店舗選択 -->
    <div id="storeSelect" class="card">
      <div class="muted small">店舗を選ぶとホーム（状況確認）に移動します。</div>
      <div id="storeGrid" class="storeGrid"></div>
    </div>

    <!-- ② ホーム（状況確認） -->
    <div id="homeStatus" style="display:none">
      <div class="card">
        <button id="btnToStoreList" class="secondary">店舗一覧</button>
        <button id="btnReset" class="secondary">リセット</button>
        <button id="btnShowRemain" class="secondary">未スキャン一覧</button>
        <button id="btnStartScan">📷 読み取り開始</button>
      </div>

      <div class="card">
        <p class="muted">
          ※ 読み取りは「2回連続で同じコード」になったら確定します（誤読対策）<br />
          一致なし（INVALID）は履歴に残しません（ngのみカウント）
        </p>

        <div class="progressWrap">
          <div class="muted small" id="progressText">progress: -</div>
          <div class="progressBar"><div class="progressFill" id="progressFill"></div></div>
        </div>

        <div id="msg" class="muted"></div>
      </div>

      <div class="card">
        <strong>現在の一致</strong>
        <div id="current" class="stack"></div>
      </div>

      <div class="card">
        <strong>スキャン履歴（今回）</strong>
        <div id="history" class="stack"></div>
      </div>

      <div class="card" id="remainCard" style="display:none">
        <strong>未スキャン一覧（この店舗）</strong>
        <div class="muted small" style="margin-top:6px">グリッド表示：管理No／マシン名</div>
        <div id="remainList" class="remainGrid"></div>
      </div>
    </div>

    <!-- ③ 読み取り画面（カメラ起動の入口） -->
    <div id="scanScreen" style="display:none">
      <div class="card">
        <button id="btnBackHome" class="secondary">← ホームへ戻る</button>
        <button id="btnCamera">📷 カメラでスキャン（全画面・連続）</button>
      </div>

      <div class="card">
        <div class="muted small">
          ※ ここは読み取り専用です。状況確認（履歴/未スキャン）はホームで見ます。
        </div>

        <!-- 手入力/レーザースキャナ入力（必要なら） -->
        <input id="scanInput" placeholder="（任意）ここにフォーカス → スキャン…" autocomplete="off" />
        <div class="muted small" style="margin-top:8px">Enterで確定（一致したものだけ記録）</div>
      </div>
    </div>
  </main>

  <div id="doneOverlay">
    <div id="doneCard">
      <div id="doneTitle">棚卸完了！🎉</div>
      <div id="doneSub">全件スキャン済みです</div>
      <button id="btnDoneClose" class="secondary">閉じる</button>
    </div>
  </div>

  <!-- カメラ全画面モーダル（既存レイアウト維持） -->
  <div id="camModal" aria-hidden="true">
    <div id="camTop">
      <div class="camTopLeft">
        <div id="camStatus" class="camStatus">camera: -</div>
        <div id="camHint" class="camHint">バーコード帯を枠に入れる／番号でもOK</div>
        <div class="camSubHint">※ 読めない時は距離を少し変える（近すぎ/遠すぎ）</div>
      </div>

      <div class="camTopRight">
        <div class="toolPill">
          <span class="pillLabel">ZOOM</span>
          <input id="zoomRange" type="range" min="1" max="3" step="0.1" value="1.6" />
          <span id="zoomVal" class="pillVal">1.6x</span>
        </div>

        <button id="btnTorch" class="secondary">🔦</button>
        <button id="camClose" class="secondary">⏹ 閉じる</button>
      </div>
    </div>

    <div id="videoWrap">
      <video id="camVideo" playsinline muted></video>

      <!-- overlay -->
      <div id="overlay" aria-hidden="true">
        <div class="guideText">バーコード帯をここに（読めない時は番号でもOK）</div>

        <div class="band top"></div>
        <div class="band bottom"></div>

        <div class="corner tl"></div>
        <div class="corner tr"></div>
        <div class="corner br"></div>
        <div class="corner bl"></div>

        <div id="flash" class="flash"></div>
      </div>
    </div>

    <div id="toast" class="toast" aria-hidden="true"></div>
    <div id="ocrBadge" class="ocrBadge" aria-hidden="true">OCR準備中…</div>
  </div>

  <script src="./app.js"></script>
</body>
</html>
