<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>æ£šå¸ã‚¹ã‚­ãƒ£ãƒŠ</title>

<!-- ã‚«ãƒ¡ãƒ©ç”¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒª -->
<script src="https://unpkg.com/html5-qrcode"></script>

<style>
body{margin:0;font-family:system-ui,-apple-system,BlinkMacSystemFont;background:#0b1220;color:#e5e7eb}
header{padding:14px;font-size:20px;font-weight:700}
.badges{display:flex;flex-wrap:wrap;gap:8px;padding:0 14px 8px}
.badge{background:#1e293b;padding:6px 10px;border-radius:999px;font-size:13px}
button{background:#1e40af;color:#fff;border:none;border-radius:10px;padding:10px 14px;font-size:15px}
button.secondary{background:#334155}
main{padding:14px}
.card{background:#111827;border-radius:14px;padding:14px;margin-bottom:14px}
input{width:100%;padding:14px;font-size:16px;border-radius:12px;border:1px solid #334155;background:#020617;color:#fff}
#qrReader{width:100%;height:60vh;position:relative;margin-top:10px}

/* èµ¤ã„ã‚¹ã‚­ãƒ£ãƒ³ãƒ©ã‚¤ãƒ³ */
#qrReader::after{
  content:"";position:absolute;top:50%;left:8%;width:84%;height:2px;
  background:#ff3b30;pointer-events:none;opacity:.95
}
/* èª¬æ˜ */
#qrReader::before{
  content:"èµ¤ã„ç·šã«ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚’åˆã‚ã›ã¦ãã ã•ã„";
  position:absolute;top:10px;width:100%;
  text-align:center;font-size:13px;color:#ff6b6b;pointer-events:none
}

.ok{color:#22c55e}
.ng{color:#ef4444}
.muted{color:#94a3b8;white-space:pre-line}
.storeCard{
  display:block;background:#020617;border-radius:12px;padding:14px;
  margin-bottom:10px;text-decoration:none;color:#fff
}
</style>
</head>

<body>
<header id="title">æ£šå¸ã‚¹ã‚­ãƒ£ãƒŠï¼ˆåº—èˆ—é¸æŠï¼‰</header>

<div class="badges">
  <div class="badge" id="storeBadge">store: HOME</div>
  <div class="badge" id="countBadge">rows: -</div>
  <div class="badge" id="progressBadge">progress: -</div>
  <div class="badge" id="updatedBadge">updated: -</div>
</div>

<main>

<!-- åº—èˆ—é¸æŠ -->
<div id="home" class="card">
  <div id="storeGrid"></div>
</div>

<!-- ã‚¹ã‚­ãƒ£ãƒŠ -->
<div id="scanner" style="display:none">

  <div class="card">
    <button id="btnHome" class="secondary">åº—èˆ—ä¸€è¦§</button>
    <button id="btnClear" class="secondary">ä»Šå›ã‚’ã‚¯ãƒªã‚¢</button>
  </div>

  <div class="card">
    <p class="muted">
      â€» ã‚«ãƒ¡ãƒ© or ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚¹ã‚­ãƒ£ãƒŠï¼ˆEnterã§ç¢ºå®šï¼‰<br>
      å…¥åŠ›æ¬„ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã—ãŸã¾ã¾é‹ç”¨ã—ã¦ãã ã•ã„
    </p>

    <button id="btnCamera">ğŸ“· ã‚«ãƒ¡ãƒ©ã§ã‚¹ã‚­ãƒ£ãƒ³</button>
    <button id="btnStopCamera" class="secondary">â¹ ã‚«ãƒ¡ãƒ©åœæ­¢</button>

    <div id="cameraWrap" style="display:none">
      <div id="qrReader"></div>
    </div>

    <input id="scanInput" placeholder="ã“ã“ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ â†’ ã‚¹ã‚­ãƒ£ãƒ³â€¦" autocomplete="off" />
    <div id="msg" class="muted"></div>
  </div>

  <div class="card">
    <strong>ç¾åœ¨ã®ä¸€è‡´</strong>
    <div id="current" style="margin-top:10px"></div>
  </div>

  <div class="card">
    <strong>ã‚¹ã‚­ãƒ£ãƒ³å±¥æ­´ï¼ˆä»Šå›ï¼‰</strong>
    <div id="history" style="margin-top:10px"></div>
  </div>

</div>

</main>

<script>
/* ========= è¨­å®š ========= */
const DATA_CSV_URL =
 "https://docs.google.com/spreadsheets/d/e/2PACX-1vRWOsLuIiIAdMPSlO896mqWtV6wwPdnRtofYq11XqKWwKeg1rauOgt0_mMOxbvP3smksrXMCV5ZROaG/pub?gid=2104427305&single=true&output=csv";

/* ========= çŠ¶æ…‹ ========= */
const el = (id) => document.getElementById(id);
const qs = new URLSearchParams(location.search);
let STORE = (qs.get("store") || "").trim();

const st = { all: [], rows: [], byCode: new Map(), scanned: [] };

const normalize = (s) => String(s || "").trim()
  .replace(/\r?\n/g, "")
  .replace(/[ï¼-ï¼™]/g, c => String.fromCharCode(c.charCodeAt(0) - 0xFEE0));

/* ========= CSVï¼ˆç°¡æ˜“ï¼šä»Šå›ã®DATAã¯ã‚«ãƒ³ãƒã‚„æ”¹è¡ŒãŒå…¥ã‚‰ãªã„æƒ³å®šï¼‰ ========= */
function parseCSV(t){
  const lines = t.replace(/\r/g,"").split("\n").filter(Boolean);
  if(!lines.length) return [];
  const header = lines.shift().split(",").map(x=>x.trim());
  const idx = {};
  header.forEach((h,i)=>idx[h]=i);

  const pick = (cols, key) => (idx[key] == null) ? "" : (cols[idx[key]] ?? "");

  return lines.map(line=>{
    const cols = line.split(",").map(x => x.replace(/^"|"$/g,"").replace(/""/g,'"'));
    return {
      store_key: pick(cols,"store_key"),
      store_name: pick(cols,"store_name"),
      code: pick(cols,"code"),
      machine_name: pick(cols,"machine_name"),
      actual_stock: pick(cols,"actual_stock"),
      updated_at: pick(cols,"updated_at"),
    };
  });
}

/* ========= ç”»é¢ ========= */
function setMode(mode){
  el("home").style.display = (mode === "home") ? "" : "none";
  el("scanner").style.display = (mode === "scan") ? "" : "none";
}

function updateBadges(){
  el("storeBadge").textContent = "store: " + (STORE || "HOME");
  el("countBadge").textContent = "rows: " + (STORE ? st.rows.length : "-");

  const total = STORE ? st.rows.length : 0;
  const done = new Set(st.scanned.filter(x=>x.ok).map(x=>x.code)).size;
  el("progressBadge").textContent = STORE ? `progress: ${done}/${total}` : "progress: -";

  const u = st.rows[0]?.updated_at || st.all[0]?.updated_at || "-";
  el("updatedBadge").textContent = "updated: " + String(u).slice(0, 10);
}

function renderHome(){
  setMode("home");
  el("title").textContent = "æ£šå¸ã‚¹ã‚­ãƒ£ãƒŠï¼ˆåº—èˆ—é¸æŠï¼‰";

  const map = new Map();
  for(const r of st.all){
    if(!r.store_key) continue;
    if(!map.has(r.store_key)) map.set(r.store_key, r.store_name || r.store_key);
  }

  el("storeGrid").innerHTML = [...map.entries()]
    .sort((a,b)=>String(a[1]).localeCompare(String(b[1]),"ja"))
    .map(([k,n])=> `<a class="storeCard" href="?store=${encodeURIComponent(k)}">
        <b>${n}</b><div class="muted">${k}</div>
      </a>`).join("");

  updateBadges();
}

function renderScan(){
  setMode("scan");
  el("title").textContent = "æ£šå¸ã‚¹ã‚­ãƒ£ãƒŠ";
  el("msg").textContent = "èª­è¾¼å®Œäº†ã€‚å…¥åŠ›æ¬„ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã—ã¦ã‚¹ã‚­ãƒ£ãƒ³ã—ã¦ãã ã•ã„ã€‚";
  updateBadges();
  el("scanInput").focus();
}

function renderPanels(){
  updateBadges();

  const last = st.scanned[0];
  if(!last){
    el("current").innerHTML = "";
  }else if(last.ok){
    el("current").innerHTML =
      `<div class="ok">âœ… ${last.code}</div>` +
      `<div>ãƒã‚·ãƒ³: ${last.row.machine_name}</div>`;
  }else{
    el("current").innerHTML = `<div class="ng">âŒ ${last.code}</div>`;
  }

  el("history").innerHTML = st.scanned.map(x=>{
    return x.ok
      ? `<div class="ok">âœ… ${x.code} <span class="muted"> ${x.row.machine_name}</span></div>`
      : `<div class="ng">âŒ ${x.code}</div>`;
  }).join("");
}

/* ========= ã‚¹ã‚­ãƒ£ãƒ³ ========= */
function addScan(v){
  const code = normalize(v);
  if(!code) return;

  const row = st.byCode.get(code);
  const ok = !!row;

  st.scanned.unshift({ code, row, ok, ts: Date.now() });

  el("msg").textContent = ok ? "ä¸€è‡´ã—ã¾ã—ãŸ" : "ä¸€è‡´ãªã—ï¼ˆãƒªã‚¹ãƒˆã«ã‚ã‚Šã¾ã›ã‚“ï¼‰";
  renderPanels();
  el("scanInput").focus();
}

/* ========= ã‚«ãƒ¡ãƒ© ========= */
let qr = null;
let camRunning = false;

async function startCamera(){
  if(!STORE){
    alert("å…ˆã«åº—èˆ—ã‚’é¸æŠã—ã¦ãã ã•ã„");
    return;
  }
  if(camRunning) return;

  el("cameraWrap").style.display = "";

  if(!qr) qr = new Html5Qrcode("qrReader");

  let cams = [];
  try {
    cams = await Html5Qrcode.getCameras();
  } catch (e) {
    el("cameraWrap").style.display = "none";
    alert("ã‚«ãƒ¡ãƒ©å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆæ¨©é™/HTTPSã‚’ç¢ºèªï¼‰");
    return;
  }

  if(!cams || cams.length === 0){
    el("cameraWrap").style.display = "none";
    alert("ã‚«ãƒ¡ãƒ©ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
    return;
  }

  // âœ… èƒŒé¢ã‚«ãƒ¡ãƒ©å„ªå…ˆï¼ˆlabelãŒç©ºã®æ™‚ã¯æœ«å°¾ã‚’ä½¿ã†ï¼‰
  let cameraId = null;
  for(const cam of cams){
    if(/back|rear|environment/i.test(cam.label || "")){
      cameraId = cam.id;
      break;
    }
  }
  if(!cameraId) cameraId = cams[cams.length - 1].id;

  // âœ… 1Dãƒãƒ¼ã‚³ãƒ¼ãƒ‰å‘ã‘è¨­å®š
  const config = {
    fps: 12,
    qrbox: { width: 360, height: 120 },
    disableFlip: true,
    formatsToSupport: [
      Html5QrcodeSupportedFormats.EAN_13,
      Html5QrcodeSupportedFormats.EAN_8,
      Html5QrcodeSupportedFormats.UPC_A,
      Html5QrcodeSupportedFormats.UPC_E,
      Html5QrcodeSupportedFormats.CODE_128,
      Html5QrcodeSupportedFormats.CODE_39,
    ],
  };

  const onOk = (text) => {
    stopCamera();
    addScan(text);
  };
  const onErr = (_err) => {};

  camRunning = true;

  try {
    // âœ… ã¾ãšã¯èƒŒé¢æŒ‡å®šï¼ˆiPhoneã§å®‰å®šã—ã‚„ã™ã„ï¼‰
    await qr.start({ facingMode: "environment" }, config, onOk, onErr);
  } catch (e1) {
    try {
      // âœ… ã ã‚ãªã‚‰ deviceId ã§ç¢ºå®Ÿã«èƒŒé¢ã£ã½ã„ã‚«ãƒ¡ãƒ©ã¸
      await qr.start({ deviceId: { exact: cameraId } }, config, onOk, onErr);
    } catch (e2) {
      // âœ… ã©ã£ã¡ã‚‚å¤±æ•—ï¼šå¾Œå§‹æœ«
      camRunning = false;
      el("cameraWrap").style.display = "none";
      alert("ã‚«ãƒ¡ãƒ©èµ·å‹•ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆSafariã®æ¨©é™/åˆ¥ã‚¿ãƒ–èµ·å‹•/å†èª­ã¿è¾¼ã¿ã‚’è©¦ã—ã¦ãã ã•ã„ï¼‰");
    }
  }
}

await qr.start(
  { facingMode: "environment" }, // âœ… èƒŒé¢ã‚«ãƒ¡ãƒ©å„ªå…ˆï¼ˆiPhoneã§å®‰å®šã—ã‚„ã™ã„ï¼‰
  {
    fps: 12,
    qrbox: { width: 360, height: 120 }, // âœ… æ¨ªé•·ãƒãƒ¼ã‚³ãƒ¼ãƒ‰å‘ã‘
    disableFlip: true,
    formatsToSupport: [
      Html5QrcodeSupportedFormats.EAN_13,
      Html5QrcodeSupportedFormats.EAN_8,
      Html5QrcodeSupportedFormats.UPC_A,
      Html5QrcodeSupportedFormats.UPC_E,
      Html5QrcodeSupportedFormats.CODE_128,
      Html5QrcodeSupportedFormats.CODE_39,
    ],
  },
  (text) => {
    stopCamera();
    addScan(text);
  },
  (_err) => {}
);

 
}

async function stopCamera(){
  el("cameraWrap").style.display = "none";
  if(!qr || !camRunning) return;
  try{
    await qr.stop();
  }catch(_e){
    // iOSã§ãŸã¾ã«stopä¾‹å¤–ã«ãªã‚‹ãŒç„¡è¦–ã§OK
  }finally{
    camRunning = false;
  }
}

/* ========= èµ·å‹• ========= */
(async () => {
  // UI
  el("btnHome").onclick = () => location.href = "./";
  el("btnClear").onclick = () => { st.scanned = []; renderPanels(); el("msg").textContent = "ä»Šå›åˆ†ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ"; };
  el("btnCamera").onclick = () => startCamera();
  el("btnStopCamera").onclick = () => stopCamera();

  el("scanInput").addEventListener("keydown", (e) => {
    if(e.key === "Enter"){
      e.preventDefault();
      addScan(el("scanInput").value);
      el("scanInput").value = "";
    }
  });

  // iOSã§ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ãŒå¤–ã‚Œã‚„ã™ã„å¯¾ç­–ï¼ˆè»½ã‚ï¼‰
  document.addEventListener("touchstart", () => {
    const inp = el("scanInput");
    if(document.activeElement !== inp) inp.focus();
  }, { passive: true });

  // DATA
  const csvText = await fetch(DATA_CSV_URL, { cache: "no-store" }).then(r => r.text());
  st.all = parseCSV(csvText);

  // åˆæœŸstore
  const init = (new URLSearchParams(location.search)).get("store") || "";
  STORE = init.trim();

  if(!STORE){
    renderHome();
    return;
  }

  st.rows = st.all.filter(r => String(r.store_key).trim() === STORE);
  st.byCode.clear();
  for(const r of st.rows){
    const k = normalize(r.code);
    if(k) st.byCode.set(k, r);
  }

  renderScan();
  renderPanels();
})();
</script>

</body>
</html>
