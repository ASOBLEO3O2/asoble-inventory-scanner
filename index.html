<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>æ£šå¸ã‚¹ã‚­ãƒ£ãƒŠ</title>

<!-- ã‚«ãƒ¡ãƒ©ç”¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒª -->
<script src="https://unpkg.com/html5-qrcode"></script>

<style>
body {
  margin: 0;
  font-family: system-ui, -apple-system, BlinkMacSystemFont;
  background: #0b1220;
  color: #e5e7eb;
}

header {
  padding: 14px;
  font-size: 20px;
  font-weight: bold;
}

.badges {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  padding: 0 14px 8px;
}

.badge {
  background: #1e293b;
  padding: 6px 10px;
  border-radius: 999px;
  font-size: 13px;
}

button {
  background: #1e40af;
  color: #fff;
  border: none;
  border-radius: 10px;
  padding: 10px 14px;
  font-size: 15px;
}

button.secondary {
  background: #334155;
}

main {
  padding: 14px;
}

.card {
  background: #111827;
  border-radius: 14px;
  padding: 14px;
  margin-bottom: 14px;
}

input {
  width: 100%;
  padding: 14px;
  font-size: 16px;
  border-radius: 12px;
  border: 1px solid #334155;
  background: #020617;
  color: #fff;
}

#qrReader {
  width: 100%;
  height: 60vh;
  position: relative;
  margin-top: 10px;
}

/* èµ¤ã„ã‚¹ã‚­ãƒ£ãƒ³ãƒ©ã‚¤ãƒ³ */
#qrReader::after {
  content: "";
  position: absolute;
  top: 50%;
  left: 8%;
  width: 84%;
  height: 2px;
  background: #ff3b30;
  pointer-events: none;
}

/* èª¬æ˜ */
#qrReader::before {
  content: "èµ¤ã„ç·šã«ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚’åˆã‚ã›ã¦ãã ã•ã„";
  position: absolute;
  top: 10px;
  width: 100%;
  text-align: center;
  font-size: 13px;
  color: #ff6b6b;
  pointer-events: none;
}

.ok { color: #22c55e; }
.ng { color: #ef4444; }
.muted { color: #94a3b8; white-space: pre-line; }

.storeCard {
  display: block;
  background: #020617;
  border-radius: 12px;
  padding: 14px;
  margin-bottom: 10px;
  text-decoration: none;
  color: #fff;
}
</style>
</head>

<body>

<header id="title">æ£šå¸ã‚¹ã‚­ãƒ£ãƒŠï¼ˆåº—èˆ—é¸æŠï¼‰</header>

<div class="badges">
  <div class="badge" id="storeBadge">store: HOME</div>
  <div class="badge" id="countBadge">rows: -</div>
  <div class="badge" id="progressBadge">progress: -</div>
  <div class="badge" id="updatedBadge">updated: -</div>
</div>

<main>

<!-- åº—èˆ—é¸æŠ -->
<div id="home" class="card">
  <div id="storeGrid"></div>
</div>

<!-- ã‚¹ã‚­ãƒ£ãƒŠ -->
<div id="scanner" style="display:none">

  <div class="card">
    <button id="btnHome" class="secondary">åº—èˆ—ä¸€è¦§</button>
    <button id="btnClear" class="secondary">ä»Šå›ã‚’ã‚¯ãƒªã‚¢</button>
  </div>

  <div class="card">
    <p class="muted">
      â€» ã‚«ãƒ¡ãƒ© or ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚¹ã‚­ãƒ£ãƒŠï¼ˆEnterã§ç¢ºå®šï¼‰<br>
      å…¥åŠ›æ¬„ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã—ãŸã¾ã¾é‹ç”¨ã—ã¦ãã ã•ã„
    </p>

    <button id="btnCamera">ğŸ“· ã‚«ãƒ¡ãƒ©ã§ã‚¹ã‚­ãƒ£ãƒ³</button>
    <button id="btnStopCamera" class="secondary">â¹ ã‚«ãƒ¡ãƒ©åœæ­¢</button>

    <div id="cameraWrap" style="display:none">
      <div id="qrReader"></div>
    </div>

    <input id="scanInput" placeholder="ã“ã“ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ â†’ ã‚¹ã‚­ãƒ£ãƒ³â€¦" />
    <div id="msg" class="muted"></div>
  </div>

  <div class="card">
    <strong>ç¾åœ¨ã®ä¸€è‡´</strong>
    <div id="current"></div>
  </div>

  <div class="card">
    <strong>ã‚¹ã‚­ãƒ£ãƒ³å±¥æ­´ï¼ˆä»Šå›ï¼‰</strong>
    <div id="history"></div>
  </div>

</div>

</main>

<script>
/* ========= è¨­å®š ========= */
const DATA_CSV_URL =
 "https://docs.google.com/spreadsheets/d/e/2PACX-1vRWOsLuIiIAdMPSlO896mqWtV6wwPdnRtofYq11XqKWwKeg1rauOgt0_mMOxbvP3smksrXMCV5ZROaG/pub?gid=2104427305&single=true&output=csv";

/* ========= çŠ¶æ…‹ ========= */
const el = id => document.getElementById(id);
const qs = new URLSearchParams(location.search);
let STORE = (qs.get("store") || "").trim();
const st = { all:[], rows:[], byCode:new Map(), scanned:[] };

const normalize = s => String(s||"").trim();

/* ========= CSV ========= */
function parseCSV(t){
  const l=t.replace(/\r/g,"").split("\n").filter(Boolean);
  const h=l.shift().split(",");
  return l.map(r=>{
    const c=r.split(",");
    const o={};
    h.forEach((k,i)=>o[k]=c[i]||"");
    return o;
  });
}

/* ========= ç”»é¢ ========= */
function setMode(m){
  home.style.display = m==="home"?"":"none";
  scanner.style.display = m==="scan"?"":"none";
}

function updateBadges(){
  storeBadge.textContent="store: "+(STORE||"HOME");
  countBadge.textContent="rows: "+(STORE?st.rows.length:"-");
  progressBadge.textContent="progress: "+st.scanned.length+"/"+st.rows.length;
  updatedBadge.textContent="updated: "+(st.rows[0]?.updated_at||"-");
}

function renderHome(){
  setMode("home");
  const map=new Map();
  st.all.forEach(r=>map.set(r.store_key,r.store_name));
  storeGrid.innerHTML=[...map.entries()].map(([k,n])=>
    `<a class="storeCard" href="?store=${k}">${n}<div class="muted">${k}</div></a>`
  ).join("");
}

function renderScan(){
  setMode("scan");
  updateBadges();
  scanInput.focus();
}

/* ========= ã‚¹ã‚­ãƒ£ãƒ³ ========= */
function addScan(v){
  const c=normalize(v);
  const row=st.byCode.get(c);
  st.scanned.unshift({code:c,row,ok:!!row});
  msg.textContent=row?"ä¸€è‡´ã—ã¾ã—ãŸ":"ä¸€è‡´ãªã—";
  current.innerHTML=row?
    `<div class="ok">âœ… ${c}<br>${row.machine_name}</div>`:
    `<div class="ng">âŒ ${c}</div>`;
  history.innerHTML=st.scanned.map(x=>x.ok?
    `âœ… ${x.code}`:`âŒ ${x.code}`).join("<br>");
}

/* ========= ã‚«ãƒ¡ãƒ© ========= */
let qr=null;
async function startCamera(){
  cameraWrap.style.display="";
  if(!qr) qr=new Html5Qrcode("qrReader");
  const cams=await Html5Qrcode.getCameras();
  const id=cams[0].id;
  await qr.start(
    {deviceId:{exact:id}},
    {
      fps:15,
      qrbox:{width:320,height:120},
      disableFlip:true,
      formatsToSupport:[
        Html5QrcodeSupportedFormats.EAN_13,
        Html5QrcodeSupportedFormats.CODE_128
      ]
    },
    t=>{stopCamera();addScan(t);}
  );
}
async function stopCamera(){
  cameraWrap.style.display="none";
  if(qr) await qr.stop();
}

/* ========= èµ·å‹• ========= */
(async()=>{
  const csv=await fetch(DATA_CSV_URL).then(r=>r.text());
  st.all=parseCSV(csv);
  if(STORE){
    st.rows=st.all.filter(r=>r.store_key===STORE);
    st.rows.forEach(r=>st.byCode.set(normalize(r.code),r));
    renderScan();
  }else{
    renderHome();
  }
})();

btnCamera.onclick=startCamera;
btnStopCamera.onclick=stopCamera;
btnHome.onclick=()=>location.href="./";
scanInput.onkeydown=e=>{
  if(e.key==="Enter"){addScan(scanInput.value);scanInput.value="";}
};
</script>

</body>
</html>
