<!doctype html>
<html lang="ja">
<head>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>棚卸スキャナ</title>
  <style>
    body{
      font-family:system-ui,-apple-system,"Noto Sans JP",sans-serif;
      background:#0b0f17;color:#e8eefc;margin:0
    }
    .wrap{max-width:1100px;margin:18px auto;padding:0 14px}
    .top{display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .badge{padding:6px 10px;border-radius:999px;background:#162242;border:1px solid #2b3a60;font-size:13px}
    .btn{padding:10px 12px;border-radius:12px;border:1px solid #2b3a60;background:#162242;color:#e8eefc}
    .btn:active{transform:scale(0.99)}
    .card{background:#11182a;border:1px solid #22304f;border-radius:16px;padding:14px;margin-top:12px}
    input{
      width:100%;padding:16px 12px;border-radius:14px;
      border:1px solid #2b3a60;background:#0b1020;color:#e8eefc;font-size:18px
    }
    .grid{display:grid;grid-template-columns:1fr;gap:12px;margin-top:12px}
    @media(min-width:900px){.grid{grid-template-columns:1fr 1fr}}
    .list{
      height:46vh;min-height:280px;overflow:auto;white-space:pre-wrap;
      font-family:ui-monospace,Menlo,Consolas,monospace;font-size:13px
    }
    .ok{color:#7CFF8A}.ng{color:#FF7C7C}.muted{color:#9bb0d6}
    .storeGrid{display:grid;grid-template-columns:1fr;gap:10px}
    @media(min-width:680px){.storeGrid{grid-template-columns:1fr 1fr}}
    a.storeCard{
      display:block;text-decoration:none;color:inherit;
      background:#11182a;border:1px solid #22304f;border-radius:16px;padding:14px
    }
    a.storeCard:active{transform:scale(0.99)}
    .storeName{font-weight:800;font-size:18px}
    .pill{
      display:inline-block;margin-top:10px;padding:4px 10px;
      border-radius:999px;background:#162242;border:1px solid #2b3a60;font-size:12px
    }
  </style>
</head>

<body>
<div class="wrap">

  <!-- ===== 上部 ===== -->
  <div class="top">
    <div class="row">
      <b id="title">棚卸スキャナ</b>
      <span class="badge" id="storeBadge">store: -</span>
      <span class="badge" id="countBadge">rows: -</span>
      <span class="badge" id="progressBadge">progress: -</span>
      <span class="badge" id="updatedBadge">updated: -</span>
    </div>
    <div class="row">
      <button class="btn" id="btnHome">店舗一覧</button>
      <button class="btn" id="btnClear">今回をクリア</button>
    </div>
  </div>

  <!-- ===== 店舗一覧 ===== -->
  <div id="home" class="card" style="display:none">
    <div class="muted">店舗を選ぶとスキャン画面に移動します。</div>
    <div class="storeGrid" id="storeGrid"></div>
  </div>

  <!-- ===== スキャン画面 ===== -->
  <div id="scanner" style="display:none">

    <div class="card">
      <div class="muted">※ バーコードスキャナ → Enterで確定（ここにフォーカスしたまま運用）</div>
      <input id="scanInput" inputmode="none" placeholder="ここにフォーカス → スキャン..." />
      <div id="msg" class="muted"></div>
    </div>

    <div class="grid">
      <div class="card">
        <div class="row" style="justify-content:space-between">
          <b>現在の一致</b><span class="badge" id="hitBadge">-</span>
        </div>
        <div id="current" class="list"></div>
      </div>

      <div class="card">
        <div class="row" style="justify-content:space-between">
          <b>スキャン履歴</b><span class="badge" id="historyBadge">0</span>
        </div>
        <div id="history" class="list"></div>
      </div>
    </div>

  </div>
</div>

<script>
/* ================= 設定 ================= */

// ★ あなたの公開CSV
const DATA_CSV_URL =
 "https://docs.google.com/spreadsheets/d/e/2PACX-1vRWOsLuIiIAdMPSlO896mqWtV6wwPdnRtofYq11XqKWwKeg1rauOgt0_mMOxbvP3smksrXMCV5ZROaG/pub?gid=2104427305&single=true&output=csv";

/* ================= 状態 ================= */

const el = id => document.getElementById(id);
const qs = new URLSearchParams(location.search);
let STORE = (qs.get("store") || "").trim();

const st = { all:[], rows:[], byCode:new Map(), scanned:[] };

/* ================= 共通 ================= */

const normalizeCode = v =>
  String(v||"").trim()
    .replace(/\r?\n/g,"")
    .replace(/[０-９]/g,c=>String.fromCharCode(c.charCodeAt(0)-0xFEE0));

const esc = s => String(s||"")
  .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");

function parseCSV(t){
  const r=[],s=t.replace(/\r/g,""); let row=[],c="",q=false;
  for(let i=0;i<s.length;i++){
    const ch=s[i];
    if(q){ if(ch=='"'&&s[i+1]!='"'){q=false}else{c+=ch;if(ch=='"')i++} continue }
    if(ch=='"'){q=true}
    else if(ch==','){row.push(c);c=""}
    else if(ch=='\n'){row.push(c); if(row.some(v=>v))r.push(row); row=[]; c=""}
    else c+=ch
  }
  row.push(c); if(row.some(v=>v))r.push(row);
  const h=r.shift(); const idx={}; h.forEach((x,i)=>idx[x]=i);
  return r.map(v=>({
    store_key:v[idx.store_key], store_name:v[idx.store_name],
    code:v[idx.code], machine_name:v[idx.machine_name],
    actual_stock:v[idx.actual_stock], updated_at:v[idx.updated_at]
  }));
}

/* ================= 描画 ================= */

function updateBadges(){
  el("storeBadge").textContent = "store: " + (STORE||"HOME");
  el("countBadge").textContent = "rows: " + (STORE?st.rows.length:"-");
  el("historyBadge").textContent = st.scanned.length;
  const u = st.rows[0]?.updated_at || st.all[0]?.updated_at || "-";
  el("updatedBadge").textContent = "updated: " + String(u).slice(0,10);

  if(!STORE){ el("progressBadge").textContent="progress: -"; return }
  const done=new Set(st.scanned.filter(x=>x.ok).map(x=>x.code)).size;
  const total=st.rows.length;
  const pct=Math.round(done*1000/total)/10;
  el("progressBadge").textContent=`progress: ${done}/${total} (${pct}%)`;
}

function renderHome(){
  el("home").style.display="";
  el("scanner").style.display="none";
  el("title").textContent="棚卸スキャナ（店舗選択）";

  const map=new Map();
  st.all.forEach(r=>{ if(r.store_key&&!map.has(r.store_key)) map.set(r.store_key,r.store_name) });

  el("storeGrid").innerHTML=[...map.entries()].map(([k,n])=>
    `<a class="storeCard" href="?store=${k}">
      <div class="storeName">${esc(n)}</div>
      <div class="pill">スキャンへ</div>
    </a>`
  ).join("");

  updateBadges();
}

function renderScanner(){
  el("home").style.display="none";
  el("scanner").style.display="";
  el("title").textContent="棚卸スキャナ";
  updateBadges();
  el("scanInput").focus();
}

function addScan(v){
  const c=normalizeCode(v);
  if(!c)return;
  const r=st.byCode.get(c);
  st.scanned.unshift({ts:Date.now(),code:c,ok:!!r,row:r});
  el("msg").textContent=r?"一致しました":"一致なし";
  renderScanner();
}

/* ================= 起動 ================= */

async function boot(){
  const res=await fetch(DATA_CSV_URL,{cache:"no-store"});
  st.all=parseCSV(await res.text());

  el("btnHome").onclick=()=>{STORE="";history.pushState({}, "", "./");renderHome()};
  el("btnClear").onclick=()=>{st.scanned=[];updateBadges()};

  el("scanInput").addEventListener("keydown",e=>{
    if(e.key==="Enter"){ addScan(el("scanInput").value); el("scanInput").value="" }
  });

  // フォーカス維持（iPad対策）
  document.addEventListener("touchstart",()=>el("scanInput").focus(),{passive:true});
  setInterval(()=>el("scanInput").focus(),1500);

  if(!STORE){ renderHome(); return }

  st.rows=st.all.filter(r=>r.store_key===STORE);
  st.byCode.clear();
  st.rows.forEach(r=>st.byCode.set(normalizeCode(r.code),r));
  renderScanner();
}

boot();
</script>
</body>
</html>

